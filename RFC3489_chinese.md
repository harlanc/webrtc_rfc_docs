#RFC 3489


# 摘要

简单UDP穿透NATs（STUN）协议是一个轻量级的协议，应用使用此协议可以发现其是否位于NAT网络中，判断NAT类型、以及甄别公网和它们之间是否存在防火墙。同样也能够确定NAT分配给这些应用的公网IP地址。STUN适用于许多现存的NATs，能够让许多应用穿透现存的NAT网络。

# 适用声明

此协议并不能解决与NAT相关的所有问题。它不能够让TCP连接穿透NAT，允许UDP包穿透NAT，但也只限于现存NAT类型的一部分。比如，STUN是不能够让UDP包穿透对称性NAT的。

STUN不能获取同一NAT后面的主机地址。


# 介绍

网络地址转换（NATs）带来许多便利的同时，也有许多缺点。这些缺点带来的大多数麻烦是它们破坏了许多现存的IP应用，并且很难部署新的应用。于是提出了一些指导方针，描述如何才能建造"NAT友好的"协议，但是许多协议却因为这些指导方针不能被创建了。这些协议基本包括了所有的点对点协议，像多媒体通信，文件共享和游戏。

为了克服这个问题，NATs中嵌入了应用层网关（ALGs）。为了穿透NAT，应用层网关会为一个特定的协议执行应用层函数。这包含重写应用层消息来包含转换地址，而不是插入新的消息。ALGs有一系列的局限性，包括可扩展性，可靠性以及部署新应用的速度。为了解决这些问题，设计了中间件通信协议（MIDCOM）。为了获取NAT绑定以及打开或关闭网络穿洞，MIDCOM允许一个应用实体（比如一个终端或者一些类型的网络服务器（比如一个SIP代理））来控制NAT（或者防火墙）。用这种方式，NATs和应用会再次被隔离开，就不需要在NATs中嵌入ALGs了，同时也解决了现有架构的局限性。

不幸的是，MIDCOM出了要更新应用组件之外，还需要更新现存NAT和防火墙。这些NAT的完整更新需要很长一段时间，甚至要数年的时间。一部分原始是因为部署和使用应用的人与部署NAT和防火墙的人不是同一群人。许多情况下更新这些设备的意愿不会很高。比如，一个机场因特网休息室通过NAT访问互联网。连接到NATed网络的用户希望使用点对点服务，但是NAT却不支持。既然休息室的管理人员同服务提供者不是同一群人，他们没有动机更新NAT设备来支持点对点服务，不论是使用ALG还是MIDCOM。

另外一个问题是MIDCOM协议需要控制中间件的agent知道这些中间件的身份，并且这些agent要有访问控制权。在许多配置中，这是不可能的。比如，许多电缆接入提供商在其整个接入网络前使用NAT。这个NAT可能是由终端用户购买和操作的住宅NAT的补充。终端用户将可能不会拥有位于有线访问网络中NAT的控制权，甚至不可能知道它的存在。

许多现存的专有协议，比如为在线游戏（像RFC3027中描述的游戏）和VoIP，已经开发了一些技巧，允许在不改变NAT的情况下穿透NAT进行操作。这篇文档试图采用其中的一些想法，将其编写成可互操作的协议，来满足很多应用的需求。

这里所描述的协议，STUN，**允许一个NAT后面的实体先去发现NAT的存在和类型，然后获知NAT分配的地址绑定。STUN不需要对NAT进行更改，并且可以在应用实体和公网之间协同使用任意数量的NATs。**

# 术语表


# 定义

STUN 客户端： 一个STUN客户端(也被成为客户端)是生成STUN请求的一个实体。一个STUN客户端在一个终端系统上运行，比如用户的PC，或者运行在网络元素中，比如一个会议服务器。

STUN服务器：一个STUN服务器（也被称作服务器）是接受STUN请求的实体，并且发送STUN响应。STUN服务器通常被连接到公网中。


# NAT变种

我们假设读者对NAT是熟悉的。我们可以观察到在不同的实现中对UDP NAT的处理是不一样的。在实现中观察到的四种处理情况如下：

 - **全锥形NAT**
 
 来自同一内网IP和端口号的所有请求都被映射到相同的外部IP地址和端口。并且，任何外部主机都可以通过映射的外部地址来将网络包转发到内网主机。
- **限制锥形NAT**

   来自同一内网IP和端口的所有请求都被映射到相同的外部IP地址和端口。不像全锥形NAT，只有内网主机向一个IP地址为X的外部主机发送过数据包，地址X的外部主机才能向此内网主机发送数据包。

- **端口限制型NAT**

 端口限制型NAT和限制锥形NAT类似，但是此限制也包括端口号。也就是说，源IP地址X和源端口号P的外部主机向内网主机发送数据，只有此内网主机向此外部主机（IP地址为X）的端口P发送过数据才会成功。
 
-  **对称型NAT**

 来自于同一内网IP地址和端口号的所有请求，发送到特定的目的IP地址和端口（注意，要满足这两个条件），内网IP和端口号会被映射到相同的外部IP和端口号。如果还是相同的内网IP和端口号，但是发送到不同的目标（不管是地址变还是端口变），会使用另外一个映射。并且，只有接收到一个内部主机数据包的外部主机，才能向此内部主机发送UDP数据包。

在许多情况下，判断NAT类型是很重要的。根据应用想要达到的不同目的，可能会采取不同的操作。

# 操作概述

这一节只是描述性的。标准的行为在第8和9节中进行描述。

![](http:/qiniu.harlanc.vip/4.11.2019_8:59:46.png)

典型的STUN配置如图一所示。一个STUN客户端被连接到私网1.私网1通过NAT1被连接到私网2。私网2通过NAT2连接到公网。STUN服务器位于公网。

STUN协议是一个简单的客户端-服务端协议。客户端向服务端发送请求，服务端进行回应。

